#!/bin/bash
# tools/build - Compile C/C++ source code for comparison
# Usage: tools/build <source_file.c|cpp> [function_name]
#
# Compiles the given C/C++ file using the configured compiler and flags.
# Automatically detects C vs C++ based on file extension.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Load config
if [[ -f "$PROJECT_ROOT/config.sh" ]]; then
    source "$PROJECT_ROOT/config.sh"
else
    echo "BUILD FAILED: config.sh not found. Run init.sh first."
    exit 1
fi

if [[ -z "$1" ]]; then
    echo "BUILD FAILED: No source file specified."
    echo "Usage: tools/build <source_file.c> [function_name]"
    exit 1
fi

SOURCE_FILE="$1"
FUNC_NAME="${2:-}"

# Resolve to absolute path if relative
if [[ "$SOURCE_FILE" != /* ]]; then
    SOURCE_FILE="$PROJECT_ROOT/$SOURCE_FILE"
fi

if [[ ! -f "$SOURCE_FILE" ]]; then
    echo "BUILD FAILED: Source file not found: $SOURCE_FILE"
    exit 1
fi

# Detect C vs C++
EXT="${SOURCE_FILE##*.}"
if [[ "$EXT" == "cpp" ]] || [[ "$EXT" == "cc" ]] || [[ "$EXT" == "cxx" ]]; then
    IS_CPP=true
    COMPILER="${CXX:-clang++}"
    FLAGS="${CXXFLAGS:-${CFLAGS:--O2}}"
    BASENAME=$(basename "$SOURCE_FILE" ."$EXT")
else
    IS_CPP=false
    COMPILER="${CC:-clang}"
    FLAGS="${CFLAGS:--O2}"
    BASENAME=$(basename "$SOURCE_FILE" .c)
fi

INCLUDE_DIR="$PROJECT_ROOT/include"

# Create temporary output directory
BUILD_DIR="$PROJECT_ROOT/.build"
mkdir -p "$BUILD_DIR"

OBJ_FILE="$BUILD_DIR/$BASENAME.o"
ASM_FILE="$BUILD_DIR/$BASENAME.s"

echo "=== Building $SOURCE_FILE ==="
echo "Compiler: $COMPILER"
echo "Flags: $FLAGS"
if $IS_CPP; then echo "Mode: C++"; else echo "Mode: C"; fi
echo ""

# Compile to object file
if ! $COMPILER $FLAGS -I"$INCLUDE_DIR" -c "$SOURCE_FILE" -o "$OBJ_FILE" 2>&1; then
    echo ""
    echo "BUILD FAILED: Compilation errors above. You should fix these errors and try again."
    exit 1
fi

echo "BUILD SUCCESS: Object file created at $OBJ_FILE"
echo ""

# Also generate assembly for inspection
$COMPILER $FLAGS -I"$INCLUDE_DIR" -S "$SOURCE_FILE" -o "$ASM_FILE" 2>/dev/null || true

# Show disassembly
if [[ -n "$FUNC_NAME" ]]; then
    echo "=== Assembly for function $FUNC_NAME ==="
fi

# Use objdump with symbols
objdump -d "$OBJ_FILE"

# Also show the raw .s file which has better labels
if [[ -f "$ASM_FILE" ]]; then
    echo ""
    echo "=== Compiler assembly output ==="
    cat "$ASM_FILE"
fi

echo ""
echo "=== Build complete ==="
echo "Object file: $OBJ_FILE"
echo "Assembly file: $ASM_FILE"
