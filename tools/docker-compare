#!/bin/bash
# tools/docker-compare - Compare assembly inside Docker (Linux x86_64)
# Usage: tools/docker-compare <function_name> <source_file.c|cpp>

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

if [[ -z "$1" ]] || [[ -z "$2" ]]; then
    echo "ERROR: Missing arguments."
    echo "Usage: tools/docker-compare <function_name> <source_file.cpp>"
    exit 1
fi

FUNC_NAME="$1"
SOURCE_FILE="$2"

# Convert to path relative to project root
if [[ "$SOURCE_FILE" == /* ]]; then
    SOURCE_FILE="${SOURCE_FILE#$PROJECT_ROOT/}"
fi

echo "=== Comparing $FUNC_NAME (Linux x86_64 via Docker) ==="

docker run --rm --platform linux/amd64 \
    -v "$PROJECT_ROOT:/project" \
    -w /project \
    decomp-env \
    /project/tools/compare "$FUNC_NAME" "$SOURCE_FILE"
