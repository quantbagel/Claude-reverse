#!/bin/bash
# tools/demangle - Demangle C++ function names
# Usage: tools/demangle <mangled_name>
#        tools/demangle --list    # List all functions with demangled names
#
# C++ compilers mangle function names. This tool helps decode them.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Load config
if [[ -f "$PROJECT_ROOT/config.sh" ]]; then
    source "$PROJECT_ROOT/config.sh"
fi

if [[ -z "$1" ]]; then
    echo "Usage: tools/demangle <mangled_name>"
    echo "       tools/demangle --list"
    exit 1
fi

if [[ "$1" == "--list" ]]; then
    if [[ -z "$BINARY_PATH" ]] || [[ ! -f "$BINARY_PATH" ]]; then
        echo "ERROR: BINARY_PATH not set or file not found"
        exit 1
    fi

    echo "=== Functions with demangled names ==="
    echo ""
    nm "$BINARY_PATH" 2>/dev/null | grep " T \| t " | c++filt | head -100
    echo ""
    echo "(showing first 100)"
else
    # Demangle a single name
    echo "$1" | c++filt
fi
